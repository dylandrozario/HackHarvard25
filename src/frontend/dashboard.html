<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votify Dashboard - Promise Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scrollbar-hide {
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
            scrollbar-width: none;  /* Firefox */
        }
        .scrollbar-hide::-webkit-scrollbar { 
            display: none;  /* Safari and Chrome */
        }
    </style>
</head>
<body class="bg-gray-50 scrollbar-hide">
    
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-center items-center relative">
            <a href="landing.html" class="absolute left-6 flex items-center gap-2">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-xl" style="background: linear-gradient(135deg, #6A6AF0, #4A4AD0);">V</div>
                <span class="text-2xl font-bold text-gray-900">Votify</span>
            </a>
            
            <!-- Center Navigation Links -->
            <div class="flex items-center gap-6 ml-8">
                <a href="#" id="promiseCheckerNav" class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-purple-600 shadow-sm">
                    Political Promise Checker
                </a>
                <a href="#" id="stockPredictorNav" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:text-green-600 hover:bg-green-50 transition-colors">
                    Historical Stock Analysis
                </a>
            </div>
            
        </div>
    </nav>

    <!-- Warning Banner -->
    <div class="bg-yellow-50 border-b border-yellow-200">
        <div class="max-w-7xl mx-auto px-6 py-3">
            <p class="text-sm text-yellow-800">
                <strong>Demo Mode:</strong> Data verified using AI search (Perplexity) with government sources. Users should verify important claims via provided links.
            </p>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div class="flex h-screen bg-gray-50">
        <!-- Left Sidebar - Filters -->
        <div class="w-80 bg-white shadow-lg rounded-r-xl">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Filters</h2>
                
                <!-- President Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">President</label>
                    <select id="presidentFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Presidents</option>
                    </select>
                </div>

                <!-- Political Party Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Political Party</label>
                    <select id="partyFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Parties</option>
                        <option value="Republican">Republican</option>
                        <option value="Democratic">Democratic</option>
                        <option value="Independent">Independent</option>
                    </select>
        </div>

                <!-- Status Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Promise Status</label>
                    <select id="statusFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="kept">Kept</option>
                    <option value="broken">Broken</option>
                    <option value="partial">Partial</option>
                </select>
                </div>

                <!-- Category Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">All Categories</option>
                </select>
                </div>

                <!-- Clear Filters Button -->
                <button id="clearFilters" class="w-full px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Clear All Filters
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex h-[calc(100vh-140px)]">
            <!-- Main Content -->
            <div id="mainContent" class="flex-1 p-8 flex flex-col">
                <!-- Default View -->
                <div id="defaultView" class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Political Figures</h1>
                    <p class="text-gray-600">Browse and analyze political promises from government officials</p>
                </div>

                <!-- Stats Cards -->
                <div id="stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                    <!-- Stats cards inserted here by JavaScript -->
                </div>

                <!-- Political Figures Grid -->
                <div id="promises" class="flex-1 space-y-4 overflow-y-auto pr-2 scrollbar-hide">
                    <!-- Political figure cards inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="handleModalBackdropClick(event)">
        <div class="bg-white rounded-xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div id="modalContent"></div>
            <button onclick="closeModal()" class="mt-6 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Close</button>
        </div>
    </div>

    <!-- Promise Timeline Modal -->
    <div id="timelineModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="handleTimelineModalBackdropClick(event)">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h2 id="timelineTitle" class="text-2xl font-bold text-gray-900">Promise Timeline</h2>
                <button onclick="closeTimelineModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="timelineContent" class="space-y-6">
                <!-- Timeline will be populated by JavaScript -->
            </div>
            <button onclick="closeTimelineModal()" class="mt-6 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Close</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-700 font-medium">Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: window.location.hostname === 'localhost' 
                ? 'http://localhost:3000/api' 
                : '/api'
        };

        // State management
        let allPromises = [];
        let currentFilters = { status: '', president: '', category: '', party: '' };
        let currentFeature = 'all'; // Track current feature selection

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function sanitizeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJSON(obj) {
            return JSON.stringify(obj)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '&quot;');
        }

        // Load promises
        async function loadPromises() {
            showLoading();
            try {
                console.log('Attempting to fetch from:', `${CONFIG.API_BASE}/promises`);
                const response = await fetch(`${CONFIG.API_BASE}/promises`);
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Response text length:', responseText.length);
                console.log('First 200 chars:', responseText.substring(0, 200));
                
                allPromises = JSON.parse(responseText);
                
                if (!Array.isArray(allPromises)) {
                    throw new Error('Invalid data format received from API');
                }
                
                console.log('Successfully loaded', allPromises.length, 'promises');
                populateFilters();
                loadStats();
                renderPromises();
                
            } catch (error) {
                console.error('Failed to load promises:', error);
                console.error('Error details:', error);
                document.getElementById('promises').innerHTML = `
                    <div class="col-span-full bg-red-50 border border-red-200 rounded-lg p-8 text-center">
                        <p class="text-red-600 font-semibold text-lg mb-2">Failed to Load Data</p>
                        <p class="text-sm text-red-500 mb-4">${sanitizeHTML(error.message)}</p>
                        <p class="text-xs text-gray-600">Make sure the backend is running at <code class="bg-gray-100 px-2 py-1 rounded">${CONFIG.API_BASE}</code></p>
                        <p class="text-xs text-gray-500 mt-2">Check browser console (F12) for detailed error information</p>
                        <button onclick="loadPromises()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            Retry
                        </button>
                    </div>
                `;
                document.getElementById('stats').innerHTML = '';
            } finally {
                hideLoading();
            }
        }

        // Load stats (initial load with all data)
        function loadStats() {
            updateStats(allPromises);
        }

        // Update stats based on filtered data
        function updateStats(filteredPromises) {
            const stats = {
                total: filteredPromises.length,
                kept: filteredPromises.filter(p => p.status === 'kept').length,
                broken: filteredPromises.filter(p => p.status === 'broken').length,
                partial: filteredPromises.filter(p => p.status === 'partial').length
            };
            
            const accountabilityScore = stats.total > 0 
                ? Math.round((stats.kept / stats.total) * 100) 
                : 0;
            
            document.getElementById('stats').innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-blue-600">${stats.total}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Promises</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-green-600">${stats.kept}</div>
                    <div class="text-sm text-gray-600 mt-1">Kept</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-yellow-600">${stats.partial}</div>
                <div class="text-sm text-gray-600 mt-1">Partial</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-red-600">${stats.broken}</div>
                    <div class="text-sm text-gray-600 mt-1">Broken</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-purple-600">${accountabilityScore}%</div>
                    <div class="text-sm text-gray-600 mt-1">Accountability Score</div>
                </div>
            `;
        }




        // Populate filters
        function populateFilters() {
            const presidents = [...new Set(allPromises.map(p => p.president))].filter(Boolean);
            const categories = [...new Set(allPromises.map(p => p.category))].filter(Boolean);
            
            document.getElementById('presidentFilter').innerHTML = `
                <option value="">All Presidents</option>
                ${presidents.map(p => `<option value="${sanitizeHTML(p)}">${sanitizeHTML(p)}</option>`).join('')}
            `;
            
            document.getElementById('categoryFilter').innerHTML = `
                <option value="">All Categories</option>
                ${categories.map(c => `<option value="${sanitizeHTML(c)}">${sanitizeHTML(c)}</option>`).join('')}
            `;
        }

        async function loadPromisesWithValidation() {
            const promises = await fetch('http://localhost:3000/api/promises').then(r => r.json());
            
            // For each promise, add validation badge
            for (let promise of promises) {
                // Check if already validated
                if (!promise.voteverify) {
                    try {
                        const validation = await fetch('http://localhost:3000/api/validate-promise', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({promise})
                        }).then(r => r.json());
                        
                        promise.voteverify = validation;
                    } catch (e) {
                        console.error('Validation failed:', e);
                    }
                }
            }
            
            renderPromises(promises);
        }

        // Render political figures
        function renderPromises() {
            const filtered = allPromises.filter(p => {
                if (currentFilters.status && p.status !== currentFilters.status) return false;
                if (currentFilters.president && p.president !== currentFilters.president) return false;
                if (currentFilters.category && p.category !== currentFilters.category) return false;
                if (currentFilters.party && getPoliticalParty(p.president) !== currentFilters.party) return false;
                if (currentFeature !== 'all' && !hasFeature(p, currentFeature)) return false;
                return true;
            });
            
            // Update statistics based on filtered data
            updateStats(filtered);
            
            if (filtered.length === 0) {
                document.getElementById('promises').innerHTML = `
                    <div class="col-span-full text-center p-12">
                        <div class="text-gray-400 text-6xl mb-4">üîç</div>
                        <p class="text-gray-500 text-lg font-medium">No political figures match your filters</p>
                        <button onclick="resetFilters()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            // Group promises by president to create political figure cards
            const figures = {};
            filtered.forEach(promise => {
                if (!figures[promise.president]) {
                    figures[promise.president] = {
                        name: promise.president,
                        promises: [],
                        party: getPoliticalParty(promise.president),
                        servicePeriod: getServicePeriod(promise.president),
                        location: "United States"
                    };
                }
                figures[promise.president].promises.push(promise);
            });
            
            document.getElementById('promises').innerHTML = Object.values(figures).map(figure => `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 cursor-pointer"
                     onclick='openAnalysisNew(${JSON.stringify(figure).replace(/'/g, "&#39;")})'>
                    
                    <!-- Profile Section -->
                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl" style="background: linear-gradient(135deg, #6A6AF0, #4A4AD0);">
                            ${figure.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-900 text-lg">${figure.name}</h3>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${getPartyColor(figure.party)}">
                                    ${figure.party}
                        </span>
                            </div>
                            <p class="text-gray-600 text-sm">President of the United States</p>
                            <p class="text-gray-500 text-sm">${figure.servicePeriod}</p>
                        </div>
                    </div>
                    
                    <!-- Location and Features -->
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2 text-sm text-gray-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            <span>${figure.location}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                ‚úì Political Promise Checker
                            </span>
                            ${figure.promises.some(p => hasFeature(p, 'stock-predictor')) ? `
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    ‚úì Stock Predictor
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Promise Summary -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Promise Analysis</span>
                            <span class="text-sm text-gray-500">${figure.promises.length} promises</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-green-50 p-2 rounded-lg">
                                <div class="text-green-600 font-bold">${figure.promises.filter(p => p.status === 'kept').length}</div>
                                <div class="text-xs text-green-600">Kept</div>
                            </div>
                            <div class="bg-yellow-50 p-2 rounded-lg">
                                <div class="text-yellow-600 font-bold">${figure.promises.filter(p => p.status === 'partial').length}</div>
                                <div class="text-xs text-yellow-600">Partial</div>
                            </div>
                            <div class="bg-red-50 p-2 rounded-lg">
                                <div class="text-red-600 font-bold">${figure.promises.filter(p => p.status === 'broken').length}</div>
                                <div class="text-xs text-red-600">Broken</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-4 flex gap-2">
                        <button class="flex-1 text-white py-2 px-4 rounded-lg transition-all duration-300 font-medium" style="background: linear-gradient(90deg, #6A6AF0, #4A4AD0);" onmouseover="this.style.background='linear-gradient(90deg, #5A5AE0, #3A3AC0)'" onmouseout="this.style.background='linear-gradient(90deg, #6A6AF0, #4A4AD0)'">
                            VIEW DETAILED ANALYSIS
                        </button>
                        <button onclick="event.stopPropagation(); showPromiseTimeline('${figure.name}', ${JSON.stringify(figure.promises).replace(/"/g, '&quot;')})" class="px-4 py-2 text-white rounded-lg transition-colors font-medium" style="background: #6A6AF0;" onmouseover="this.style.background='#5A5AE0'" onmouseout="this.style.background='#6A6AF0'">
                            üìÖ Timeline
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Update charts with filtered data
        }

        // Helper functions for political figures
        function getPoliticalParty(president) {
            const parties = {
                'George W. Bush': 'Republican',
                'Barack Obama': 'Democratic',
                'Donald Trump': 'Republican',
                'Joe Biden': 'Democratic'
            };
            return parties[president] || 'Independent';
        }

        function getServicePeriod(president) {
            const periods = {
                'George W. Bush': '2001-2009',
                'Barack Obama': '2009-2017',
                'Donald Trump': '2017-2021',
                'Joe Biden': '2021-Present'
            };
            return periods[president] || 'Unknown';
        }

        function getPartyColor(party) {
            const colors = {
                'Republican': 'bg-red-100 text-red-800',
                'Democratic': 'bg-blue-100 text-blue-800',
                'Independent': 'bg-gray-100 text-gray-800'
            };
            return colors[party] || 'bg-gray-100 text-gray-800';
        }

        function getStatusBorderColor(status) {
            const colors = {
                kept: 'border-green-500',
                broken: 'border-red-500',
                partial: 'border-yellow-500'
            };
            return colors[status] || 'border-gray-500';
        }

        function hasFeature(promise, feature) {
            // Mock logic for feature detection - can be expanded based on actual data
            switch (feature) {
                case 'promise-checker':
                    // All promises are related to promise checking
                    return true;
                case 'stock-predictor':
                    // Check if promise affects industries with stock implications
                    return promise.affectedIndustries?.some(ind => 
                        ind.name.toLowerCase().includes('stock') || 
                        ind.name.toLowerCase().includes('market') ||
                        ind.name.toLowerCase().includes('finance') ||
                        ind.name.toLowerCase().includes('banking')
                    ) || false;
                default:
                    return true;
            }
        }

        function updateNavActiveState() {
            // Keep Political Promise Checker permanently active since we're on dashboard.html
            document.getElementById('promiseCheckerNav').className = 'px-4 py-2 rounded-lg text-sm font-medium text-white bg-purple-600 shadow-sm';
            
            // Reset stock predictor nav link
            document.getElementById('stockPredictorNav').className = 'px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:text-green-600 hover:bg-green-50 transition-colors';
            
            // Set active state based on current feature (only affects stock predictor)
            if (currentFeature === 'stock-predictor') {
                document.getElementById('stockPredictorNav').className = 'px-4 py-2 rounded-lg text-sm font-medium text-white bg-green-600 shadow-sm';
            }
        }

        function getStatusColor(status) {
            const colors = {
                kept: 'bg-green-100 text-green-800',
                broken: 'bg-red-100 text-red-800',
                partial: 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getCredibilityColor(level) {
            const colors = {
                high: 'bg-green-100 text-green-700',
                medium: 'bg-yellow-100 text-yellow-700',
                low: 'bg-orange-100 text-orange-700',
                unverified: 'bg-red-100 text-red-700'
            };
            return colors[level] || 'bg-gray-100 text-gray-700';
        }

        async function openAnalysis(figure) {
            // Show modal immediately with loading state
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modalContent').innerHTML = `
                <div class="flex items-center justify-center p-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <span class="ml-3 text-gray-600">Loading detailed analysis...</span>
                </div>
            `;

            try {
                // Get all promises for this political figure
                const promises = figure.promises || [];
                
                // Calculate summary statistics
                const totalPromises = promises.length;
                const keptPromises = promises.filter(p => p.status === 'kept').length;
                const brokenPromises = promises.filter(p => p.status === 'broken').length;
                const partialPromises = promises.filter(p => p.status === 'partial').length;
                const verifiedPromises = promises.filter(p => p.verified).length;
                
                // Group promises by category
                const promisesByCategory = {};
                promises.forEach(promise => {
                    if (!promisesByCategory[promise.category]) {
                        promisesByCategory[promise.category] = [];
                    }
                    promisesByCategory[promise.category].push(promise);
                });

                // Display detailed analysis
                document.getElementById('modalContent').innerHTML = `
                    <!-- Header -->
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl" style="background: linear-gradient(135deg, #6A6AF0, #4A4AD0);">
                            ${figure.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">${figure.name}</h2>
                            <p class="text-gray-600">${figure.party} ‚Ä¢ ${figure.servicePeriod}</p>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalPromises}</div>
                            <div class="text-sm text-blue-600">Total Promises</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${keptPromises}</div>
                            <div class="text-sm text-green-600">Kept (${Math.round((keptPromises/totalPromises)*100)}%)</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">${brokenPromises}</div>
                            <div class="text-sm text-red-600">Broken (${Math.round((brokenPromises/totalPromises)*100)}%)</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600">${partialPromises}</div>
                            <div class="text-sm text-yellow-600">Partial (${Math.round((partialPromises/totalPromises)*100)}%)</div>
                        </div>
                    </div>

                    <!-- Promises by Category -->
                    <div class="space-y-6">
                        ${Object.entries(promisesByCategory).map(([category, categoryPromises]) => `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 border-b">
                                    <h3 class="font-bold text-gray-900 flex items-center justify-between">
                                        <span>${category}</span>
                                        <span class="text-sm font-normal text-gray-500">${categoryPromises.length} promises</span>
                                    </h3>
                                </div>
                                <div class="p-4 space-y-4">
                                    ${categoryPromises.map(promise => `
                                        <div class="border-l-4 ${getStatusBorderColor(promise.status)} pl-4 py-2">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-medium text-gray-900 flex-1">${promise.promise}</h4>
                                                <div class="flex gap-2 ml-4">
                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColor(promise.status)}">
                                                        ${promise.status.toUpperCase()}
                                                    </span>
                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${getCredibilityColor(promise.credibilityLevel)}">
                                                        ${promise.verified ? '‚úì Verified' : '‚ö† Unverified'}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-sm text-gray-600 space-y-1">
                                                <p><strong>Date:</strong> ${promise.date}</p>
                                                ${promise.source ? `<p><strong>Source:</strong> <a href="${promise.source}" target="_blank" class="text-blue-600 hover:underline">${promise.source}</a></p>` : ''}
                                                ${promise.evidence ? `<p><strong>Evidence:</strong> ${promise.evidence}</p>` : ''}
                                                ${promise.affectedIndustries?.length > 0 ? `
                                                    <div class="mt-2">
                                                        <strong>Affected Industries:</strong>
                                                        <div class="flex flex-wrap gap-1 mt-1">
                                                            ${promise.affectedIndustries.map(ind => `
                                                                <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${ind.name}</span>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading detailed analysis:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-600 text-xl mb-4">‚ö†Ô∏è Error Loading Analysis</div>
                        <p class="text-gray-600 mb-4">Failed to load detailed analysis for ${figure.name}</p>
                        <p class="text-sm text-gray-500">Error: ${error.message}</p>
                    </div>
                `;
            }
            }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Analysis Modal Functions
        async function openAnalysisNew(figure) {
            // Store current figure for reference
            window.currentSelectedFigure = figure;
            
            // Show modal immediately with loading state
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modalContent').innerHTML = `
                <div class="flex items-center justify-center p-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <span class="ml-3 text-gray-600">Loading detailed analysis...</span>
                </div>
            `;

            try {
                // Get all promises for this political figure
                const promises = figure.promises || [];
                
                if (promises.length === 0) {
                    throw new Error('No promises found for this political figure');
                }

                console.log(`Analyzing ${promises.length} promises for ${figure.name}...`);

                // Try backend validation pipeline first
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/analyze-combined-validated`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            promises: promises,
                            president: figure.name,
                            maxAttempts: 3
                        })
                    });

                    if (response.ok) {
                        const analysisResult = await response.json();
                        console.log('Backend analysis result:', analysisResult);
                        
                        // Display the validated analysis
                        displayValidatedAnalysis(figure, analysisResult, promises);
                        return;
                    }
                } catch (backendError) {
                    console.log('Backend analysis unavailable, using enhanced local analysis:', backendError.message);
                }

                // Fallback to enhanced local analysis
                const enhancedAnalysis = generateEnhancedLocalAnalysis(figure, promises);
                displayEnhancedLocalAnalysis(figure, enhancedAnalysis, promises);

            } catch (error) {
                console.error('Error loading detailed analysis:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-red-600 text-xl mb-4">‚ö†Ô∏è Error Loading Analysis</div>
                        <p class="text-gray-600 mb-4">Failed to load detailed analysis for ${figure.name}</p>
                        <p class="text-sm text-gray-500">Error: ${error.message}</p>
                        <button onclick="openAnalysisNew(window.currentSelectedFigure)" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Retry Analysis
                        </button>
                    </div>
                `;
            }
        }

        function displayValidatedAnalysis(figure, analysisResult, promises) {
            // Calculate summary statistics
            const totalPromises = promises.length;
            const keptPromises = promises.filter(p => p.status === 'kept').length;
            const brokenPromises = promises.filter(p => p.status === 'broken').length;
            const partialPromises = promises.filter(p => p.status === 'partial').length;
            
            // Group promises by category
            const promisesByCategory = {};
            promises.forEach(promise => {
                if (!promisesByCategory[promise.category]) {
                    promisesByCategory[promise.category] = [];
                }
                promisesByCategory[promise.category].push(promise);
            });

            // Extract analysis data
            const analysis = analysisResult.analysis || {};
            const qualityCheck = analysisResult.qualityCheck || {};
            const statistics = analysisResult.statistics || {};

            document.getElementById('modalContent').innerHTML = `
                <!-- Header -->
                <div class="flex items-center gap-4 mb-6 pb-4 border-b">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                        ${figure.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">${figure.name}</h2>
                        <p class="text-gray-600">${figure.party} ‚Ä¢ ${figure.servicePeriod}</p>
                        ${analysisResult.validated ? '<span class="inline-block px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold mt-1">‚úì Validated Analysis</span>' : ''}
                    </div>
                </div>

                <!-- Quality Check Results -->
                ${analysisResult.validated ? `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-blue-900 mb-3">üîç Quality Assurance Results</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="text-center">
                            <div class="text-lg font-bold ${qualityCheck.biasScore >= 0.8 ? 'text-green-600' : qualityCheck.biasScore >= 0.6 ? 'text-yellow-600' : 'text-red-600'}">${Math.round(qualityCheck.biasScore * 100)}%</div>
                            <div class="text-xs text-blue-700">Bias Score</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold ${qualityCheck.hallucinationScore >= 0.8 ? 'text-green-600' : qualityCheck.hallucinationScore >= 0.6 ? 'text-yellow-600' : 'text-red-600'}">${Math.round(qualityCheck.hallucinationScore * 100)}%</div>
                            <div class="text-xs text-blue-700">Accuracy Score</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold ${qualityCheck.satisfactionScore >= 0.8 ? 'text-green-600' : qualityCheck.satisfactionScore >= 0.6 ? 'text-yellow-600' : 'text-red-600'}">${Math.round(qualityCheck.satisfactionScore * 100)}%</div>
                            <div class="text-xs text-blue-700">Overall Quality</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold ${qualityCheck.decision === 'approve' ? 'text-green-600' : qualityCheck.decision === 'approve_with_warning' ? 'text-yellow-600' : 'text-red-600'}">${qualityCheck.attempts}</div>
                            <div class="text-xs text-blue-700">Validation Attempts</div>
                        </div>
                    </div>
                    ${analysisResult.warning ? `<div class="mt-3 p-2 bg-yellow-100 border border-yellow-300 rounded text-sm text-yellow-800">‚ö†Ô∏è ${analysisResult.warning}</div>` : ''}
                </div>
                ` : ''}

                <!-- AI Analysis Summary -->
                ${analysis.overallAssessment ? `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">ü§ñ AI Analysis Summary</h3>
                    <p class="text-gray-700 text-sm leading-relaxed">${analysis.overallAssessment}</p>
                </div>
                ` : ''}

                <!-- Summary Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${totalPromises}</div>
                        <div class="text-sm text-blue-600">Total Promises</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${keptPromises}</div>
                        <div class="text-sm text-green-600">Kept (${totalPromises > 0 ? Math.round((keptPromises/totalPromises)*100) : 0}%)</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${brokenPromises}</div>
                        <div class="text-sm text-red-600">Broken (${totalPromises > 0 ? Math.round((brokenPromises/totalPromises)*100) : 0}%)</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">${partialPromises}</div>
                        <div class="text-sm text-yellow-600">Partial (${totalPromises > 0 ? Math.round((partialPromises/totalPromises)*100) : 0}%)</div>
                    </div>
                </div>

                <!-- Key Insights -->
                ${analysis.keyInsights && analysis.keyInsights.length > 0 ? `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-purple-900 mb-3">üí° Key Insights</h3>
                    <ul class="space-y-2">
                        ${analysis.keyInsights.map(insight => `
                            <li class="flex items-start gap-2 text-sm text-purple-800">
                                <span class="text-purple-600 mt-0.5">‚Ä¢</span>
                                <span>${insight}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                <!-- Promises by Category -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900">üìã Promises by Category</h3>
                    ${Object.entries(promisesByCategory).map(([category, categoryPromises]) => `
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b">
                                <h4 class="font-semibold text-gray-900">${category}</h4>
                            </div>
                            <div class="p-4 space-y-3">
                                ${categoryPromises.map(promise => `
                                    <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                        <div class="mb-3">
                                            <p class="text-sm text-gray-800 mb-2">${promise.promise}</p>
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColor(promise.status)}">
                                                    ${promise.status.toUpperCase()}
                                                </span>
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getCredibilityColor(promise.credibilityLevel)}">
                                                    ${promise.verified ? '‚úì Verified' : '‚ö† Unverified'}
                                                </span>
                                                <span class="text-xs text-gray-500">${promise.date}</span>
                                            </div>
                                        </div>
                                        
                                        ${promise.evidence && promise.evidence.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üìã Evidence:</h5>
                                                <div class="space-y-1">
                                                    ${promise.evidence.slice(0, 2).map(evidence => `
                                                        <div class="text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">${evidence}</div>
                                                    `).join('')}
                                                    ${promise.evidence.length > 2 ? `<div class="text-xs text-gray-500">+${promise.evidence.length - 2} more evidence items</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${promise.sources && promise.sources.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üîó Sources:</h5>
                                                <div class="space-y-1">
                                                    ${promise.sources.slice(0, 2).map(source => `
                                                        <div class="text-xs">
                                                            <a href="${source}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline break-all">${source}</a>
                                                        </div>
                                                    `).join('')}
                                                    ${promise.sources.length > 2 ? `<div class="text-xs text-gray-500">+${promise.sources.length - 2} more sources</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${promise.affectedIndustries && promise.affectedIndustries.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üè≠ Market Impact:</h5>
                                                <div class="space-y-1">
                                                    ${promise.affectedIndustries.slice(0, 2).map(industry => `
                                                        <div class="text-xs">
                                                            <span class="font-medium text-gray-700">${industry.name}:</span>
                                                            <span class="text-gray-600">${industry.predictedImpact}</span>
                                                            <span class="text-gray-500">(${industry.confidence}% confidence)</span>
                                                        </div>
                                                    `).join('')}
                                                    ${promise.affectedIndustries.length > 2 ? `<div class="text-xs text-gray-500">+${promise.affectedIndustries.length - 2} more industries</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Analysis Metadata -->
                <div class="mt-6 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <p>Analysis generated: ${new Date(analysisResult.generatedAt).toLocaleString()}</p>
                    <p>Promises analyzed: ${analysisResult.promisesAnalyzed}</p>
                    ${analysisResult.validated ? `<p>Quality validated: ‚úì Passed bias detection and accuracy checks</p>` : ''}
                </div>
            `;
        }

        function generateEnhancedLocalAnalysis(figure, promises) {
            // Calculate comprehensive statistics
            const totalPromises = promises.length;
            const keptPromises = promises.filter(p => p.status === 'kept');
            const brokenPromises = promises.filter(p => p.status === 'broken');
            const partialPromises = promises.filter(p => p.status === 'partial');
            
            const keptPercentage = totalPromises > 0 ? Math.round((keptPromises.length / totalPromises) * 100) : 0;
            const brokenPercentage = totalPromises > 0 ? Math.round((brokenPromises.length / totalPromises) * 100) : 0;
            const partialPercentage = totalPromises > 0 ? Math.round((partialPromises.length / totalPromises) * 100) : 0;
            
            // Analyze by category with rich data
            const categoryAnalysis = {};
            const allEvidence = [];
            const allSources = [];
            const allIndustries = [];
            
            promises.forEach(promise => {
                if (!categoryAnalysis[promise.category]) {
                    categoryAnalysis[promise.category] = { 
                        total: 0, kept: 0, broken: 0, partial: 0,
                        evidence: [], sources: [], industries: []
                    };
                }
                categoryAnalysis[promise.category].total++;
                categoryAnalysis[promise.category][promise.status]++;
                
                // Collect rich data
                if (promise.evidence && promise.evidence.length > 0) {
                    categoryAnalysis[promise.category].evidence.push(...promise.evidence);
                    allEvidence.push(...promise.evidence);
                }
                
                if (promise.sources && promise.sources.length > 0) {
                    categoryAnalysis[promise.category].sources.push(...promise.sources);
                    allSources.push(...promise.sources);
                }
                
                if (promise.affectedIndustries && promise.affectedIndustries.length > 0) {
                    categoryAnalysis[promise.category].industries.push(...promise.affectedIndustries);
                    allIndustries.push(...promise.affectedIndustries);
                }
            });
            
            // Generate insights based on rich data patterns
            const insights = [];
            
            if (keptPercentage >= 70) {
                insights.push(`${figure.name} has a strong track record with ${keptPercentage}% of promises kept`);
            } else if (keptPercentage >= 50) {
                insights.push(`${figure.name} has a mixed track record with ${keptPercentage}% of promises kept`);
            } else {
                insights.push(`${figure.name} has struggled to fulfill promises with only ${keptPercentage}% kept`);
            }
            
            // Analyze evidence quality
            const promisesWithEvidence = promises.filter(p => p.evidence && p.evidence.length > 0);
            const evidenceRate = totalPromises > 0 ? Math.round((promisesWithEvidence.length / totalPromises) * 100) : 0;
            
            if (evidenceRate >= 80) {
                insights.push(`Strong evidence base with ${evidenceRate}% of promises having documented evidence`);
            } else if (evidenceRate >= 50) {
                insights.push(`Moderate evidence coverage with ${evidenceRate}% of promises having documented evidence`);
            }
            
            // Analyze industry impact
            const promisesWithIndustryData = promises.filter(p => p.affectedIndustries && p.affectedIndustries.length > 0);
            const industryAnalysisRate = totalPromises > 0 ? Math.round((promisesWithIndustryData.length / totalPromises) * 100) : 0;
            
            if (industryAnalysisRate >= 70) {
                insights.push(`Comprehensive market impact analysis available for ${industryAnalysisRate}% of promises`);
            }
            
            // Find strongest category
            const strongestCategory = Object.entries(categoryAnalysis)
                .map(([category, stats]) => ({
                    category,
                    successRate: stats.total > 0 ? Math.round((stats.kept / stats.total) * 100) : 0,
                    total: stats.total,
                    evidenceCount: stats.evidence.length,
                    sourceCount: stats.sources.length
                }))
                .sort((a, b) => b.successRate - a.successRate)[0];
            
            if (strongestCategory && strongestCategory.total > 1) {
                insights.push(`Strongest performance in ${strongestCategory.category} with ${strongestCategory.successRate}% success rate`);
                if (strongestCategory.evidenceCount > 0) {
                    insights.push(`Most documented category: ${strongestCategory.category} with ${strongestCategory.evidenceCount} pieces of evidence`);
                }
            }
            
            // Analyze verification status
            const verifiedPromises = promises.filter(p => p.verified);
            const verificationRate = totalPromises > 0 ? Math.round((verifiedPromises.length / totalPromises) * 100) : 0;
            
            if (verificationRate >= 80) {
                insights.push(`High verification rate of ${verificationRate}% indicates reliable promise tracking`);
            }
            
            // Analyze credibility levels
            const highCredibilityPromises = promises.filter(p => p.credibilityLevel === 'high');
            const credibilityRate = totalPromises > 0 ? Math.round((highCredibilityPromises.length / totalPromises) * 100) : 0;
            
            if (credibilityRate >= 70) {
                insights.push(`High credibility assessment for ${credibilityRate}% of promises`);
            }
            
            // Generate overall assessment with rich data context
            let overallAssessment = '';
            if (keptPercentage >= 70) {
                overallAssessment = `${figure.name} demonstrates strong commitment to fulfilling campaign promises. With ${keptPercentage}% of promises kept, this indicates effective policy implementation and follow-through on commitments made to constituents.`;
            } else if (keptPercentage >= 50) {
                overallAssessment = `${figure.name} shows a mixed record on promise fulfillment. While ${keptPercentage}% of promises were kept, there are areas where commitments were not fully realized, suggesting challenges in policy execution or changing circumstances.`;
            } else {
                overallAssessment = `${figure.name} faces significant challenges in promise fulfillment with only ${keptPercentage}% kept. This suggests either overly ambitious initial commitments, changing priorities, or obstacles in policy implementation that prevented successful execution.`;
            }
            
            // Add data quality assessment
            if (evidenceRate >= 80 && industryAnalysisRate >= 70) {
                overallAssessment += ` The comprehensive evidence base and market impact analysis provide strong support for these assessments.`;
            } else if (evidenceRate >= 50) {
                overallAssessment += ` Available evidence supports these findings, though some promises lack detailed documentation.`;
            }
            
            return {
                statistics: {
                    total: totalPromises,
                    kept: keptPromises.length,
                    broken: brokenPromises.length,
                    partial: partialPromises.length,
                    keptPercentage,
                    brokenPercentage,
                    partialPercentage,
                    verificationRate,
                    evidenceRate,
                    industryAnalysisRate,
                    credibilityRate
                },
                categoryAnalysis,
                insights,
                overallAssessment,
                strongestCategory,
                richData: {
                    totalEvidence: allEvidence.length,
                    totalSources: allSources.length,
                    totalIndustries: allIndustries.length,
                    uniqueEvidence: [...new Set(allEvidence)].length,
                    uniqueSources: [...new Set(allSources)].length
                },
                generatedAt: new Date().toISOString(),
                analysisType: 'Enhanced Local Analysis with Rich Data'
            };
        }

        function displayEnhancedLocalAnalysis(figure, analysis, promises) {
            // Group promises by category
            const promisesByCategory = {};
            promises.forEach(promise => {
                if (!promisesByCategory[promise.category]) {
                    promisesByCategory[promise.category] = [];
                }
                promisesByCategory[promise.category].push(promise);
            });

            document.getElementById('modalContent').innerHTML = `
                <!-- Header -->
                <div class="flex items-center gap-4 mb-6 pb-4 border-b">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                        ${figure.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">${figure.name}</h2>
                        <p class="text-gray-600">${figure.party} ‚Ä¢ ${figure.servicePeriod}</p>
                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold mt-1">üìä Enhanced Analysis</span>
                    </div>
                </div>

                <!-- Analysis Type Notice -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-600">‚ÑπÔ∏è</span>
                        <p class="text-sm text-blue-800">
                            <strong>Enhanced Local Analysis:</strong> Backend AI validation is currently unavailable. 
                            This analysis uses advanced local algorithms to provide detailed insights based on promise data patterns.
                        </p>
                    </div>
                </div>

                <!-- Rich Data Overview -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-green-900 mb-3">üìö Data Quality Overview</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-600">${analysis.richData.totalEvidence}</div>
                            <div class="text-xs text-green-700">Evidence Items</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-600">${analysis.richData.totalSources}</div>
                            <div class="text-xs text-green-700">Source Links</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-600">${analysis.richData.totalIndustries}</div>
                            <div class="text-xs text-green-700">Industry Analyses</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-600">${analysis.statistics.evidenceRate}%</div>
                            <div class="text-xs text-green-700">Evidence Coverage</div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Summary -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">üìà Analysis Summary</h3>
                    <p class="text-gray-700 text-sm leading-relaxed">${analysis.overallAssessment}</p>
                </div>

                <!-- Summary Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${analysis.statistics.total}</div>
                        <div class="text-sm text-blue-600">Total Promises</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${analysis.statistics.kept}</div>
                        <div class="text-sm text-green-600">Kept (${analysis.statistics.keptPercentage}%)</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${analysis.statistics.broken}</div>
                        <div class="text-sm text-red-600">Broken (${analysis.statistics.brokenPercentage}%)</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">${analysis.statistics.partial}</div>
                        <div class="text-sm text-yellow-600">Partial (${analysis.statistics.partialPercentage}%)</div>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-purple-900 mb-3">üí° Key Insights</h3>
                    <ul class="space-y-2">
                        ${analysis.insights.map(insight => `
                            <li class="flex items-start gap-2 text-sm text-purple-800">
                                <span class="text-purple-600 mt-0.5">‚Ä¢</span>
                                <span>${insight}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <!-- Category Performance -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-green-900 mb-3">üìä Performance by Category</h3>
                    <div class="space-y-3">
                        ${Object.entries(analysis.categoryAnalysis).map(([category, stats]) => {
                            const successRate = stats.total > 0 ? Math.round((stats.kept / stats.total) * 100) : 0;
                            return `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-green-800">${category}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-green-700">${stats.kept}/${stats.total}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${successRate >= 70 ? 'bg-green-200 text-green-800' : successRate >= 50 ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">${successRate}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Promises by Category -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900">üìã Promises by Category</h3>
                    ${Object.entries(promisesByCategory).map(([category, categoryPromises]) => `
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b">
                                <h4 class="font-semibold text-gray-900">${category}</h4>
                            </div>
                            <div class="p-4 space-y-3">
                                ${categoryPromises.map(promise => `
                                    <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                        <div class="mb-3">
                                            <p class="text-sm text-gray-800 mb-2">${promise.promise}</p>
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColor(promise.status)}">
                                                    ${promise.status.toUpperCase()}
                                                </span>
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getCredibilityColor(promise.credibilityLevel)}">
                                                    ${promise.verified ? '‚úì Verified' : '‚ö† Unverified'}
                                                </span>
                                                <span class="text-xs text-gray-500">${promise.date}</span>
                                            </div>
                                        </div>
                                        
                                        ${promise.evidence && promise.evidence.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üìã Evidence:</h5>
                                                <div class="space-y-1">
                                                    ${promise.evidence.slice(0, 2).map(evidence => `
                                                        <div class="text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">${evidence}</div>
                                                    `).join('')}
                                                    ${promise.evidence.length > 2 ? `<div class="text-xs text-gray-500">+${promise.evidence.length - 2} more evidence items</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${promise.sources && promise.sources.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üîó Sources:</h5>
                                                <div class="space-y-1">
                                                    ${promise.sources.slice(0, 2).map(source => `
                                                        <div class="text-xs">
                                                            <a href="${source}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline break-all">${source}</a>
                                                        </div>
                                                    `).join('')}
                                                    ${promise.sources.length > 2 ? `<div class="text-xs text-gray-500">+${promise.sources.length - 2} more sources</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${promise.affectedIndustries && promise.affectedIndustries.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-xs font-semibold text-gray-700 mb-1">üè≠ Market Impact:</h5>
                                                <div class="space-y-1">
                                                    ${promise.affectedIndustries.slice(0, 2).map(industry => `
                                                        <div class="text-xs">
                                                            <span class="font-medium text-gray-700">${industry.name}:</span>
                                                            <span class="text-gray-600">${industry.predictedImpact}</span>
                                                            <span class="text-gray-500">(${industry.confidence}% confidence)</span>
                                                        </div>
                                                    `).join('')}
                                                    ${promise.affectedIndustries.length > 2 ? `<div class="text-xs text-gray-500">+${promise.affectedIndustries.length - 2} more industries</div>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Analysis Metadata -->
                <div class="mt-6 pt-4 border-t border-gray-200 text-xs text-gray-500">
                    <p>Analysis generated: ${new Date(analysis.generatedAt).toLocaleString()}</p>
                    <p>Analysis type: ${analysis.analysisType}</p>
                    <p>Verification rate: ${analysis.statistics.verificationRate}%</p>
                </div>
            `;
        }


        function handleModalBackdropClick(event) {
            if (event.target.id === 'modal') {
                closeModal();
            }
        }

        function resetFilters() {
            currentFilters = { status: '', president: '', category: '', party: '' };
            document.getElementById('statusFilter').value = '';
            document.getElementById('presidentFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('partyFilter').value = '';
            renderPromises();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            
        });

        // Filter handlers
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentFilters.status = e.target.value;
            renderPromises();
        });

        document.getElementById('presidentFilter').addEventListener('change', (e) => {
            currentFilters.president = e.target.value;
            renderPromises();
        });

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            renderPromises();
        });

        document.getElementById('partyFilter').addEventListener('change', (e) => {
            currentFilters.party = e.target.value;
            renderPromises();
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            currentFilters = { status: '', president: '', category: '', party: '' };
            document.getElementById('statusFilter').value = '';
            document.getElementById('presidentFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('partyFilter').value = '';
            renderPromises();
        });

        // Navigation feature selection
        document.getElementById('promiseCheckerNav').addEventListener('click', (e) => {
            e.preventDefault();
            currentFeature = 'promise-checker';
            updateNavActiveState();
            renderPromises();
        });

        document.getElementById('stockPredictorNav').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = 'financial-dashboard.html';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPromises();
            updateNavActiveState(); // Set initial nav state
            
            // Handle URL parameters for president filtering
            const urlParams = new URLSearchParams(window.location.search);
            const presidentParam = urlParams.get('president');
            if (presidentParam) {
                // Set the president filter after promises are loaded
                setTimeout(() => {
                    currentFilters.president = presidentParam;
                    document.getElementById('presidentFilter').value = presidentParam;
                    renderPromises();
                }, 1000); // Wait for promises to load
            }
        });

        // Timeline Modal Functions
        function showPromiseTimeline(presidentName, promises) {
            document.getElementById('timelineTitle').textContent = `${presidentName}'s Promise Timeline`;
            
            const timelineContent = document.getElementById('timelineContent');
            timelineContent.innerHTML = '';
            
            // Sort promises by date
            const sortedPromises = promises.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedPromises.forEach((promise, index) => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'relative';
                
                // Timeline line
                if (index < sortedPromises.length - 1) {
                    timelineItem.innerHTML += '<div class="absolute left-4 top-8 w-0.5 h-16 bg-gray-300"></div>';
                }
                
                // Timeline content
                timelineItem.innerHTML += `
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${getStatusBgColor(promise.status)}">
                            ${index + 1}
                        </div>
                        <div class="flex-1 bg-gray-50 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <h4 class="font-semibold text-gray-900">${promise.promise}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusColor(promise.status)}">
                                    ${promise.status.toUpperCase()}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Date:</span>
                                    <span class="font-medium">${promise.date}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Category:</span>
                                    <span class="font-medium">${promise.category}</span>
                                </div>
                            </div>
                            ${promise.evidence && promise.evidence.length > 0 ? `
                                <div class="mt-3">
                                    <span class="text-gray-600 text-sm">Evidence:</span>
                                    <div class="mt-1 space-y-1">
                                        ${promise.evidence.slice(0, 2).map(evidence => `
                                            <div class="text-sm text-gray-700 bg-white p-2 rounded border">
                                                ${evidence}
                                            </div>
                                        `).join('')}
                                        ${promise.evidence.length > 2 ? `
                                            <div class="text-xs text-gray-500 italic">
                                                +${promise.evidence.length - 2} more evidence items
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                timelineContent.appendChild(timelineItem);
            });
            
            document.getElementById('timelineModal').classList.remove('hidden');
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').classList.add('hidden');
        }

        function handleTimelineModalBackdropClick(event) {
            if (event.target === event.currentTarget) {
                closeTimelineModal();
            }
        }

        function getStatusBgColor(status) {
            const colors = {
                kept: 'bg-green-500',
                broken: 'bg-red-500',
                partial: 'bg-yellow-500'
            };
            return colors[status] || 'bg-gray-500';
        }
    </script>
</body>
</html>
