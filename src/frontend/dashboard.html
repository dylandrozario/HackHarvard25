<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votify Dashboard - Promise Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="landing.html" class="flex items-center gap-2">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">V</div>
                <span class="text-2xl font-bold text-gray-900">Votify</span>
            </a>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500">Demo User</span>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-sm font-bold">D</div>
            </div>
        </div>
    </nav>

    <!-- Warning Banner -->
    <div class="bg-yellow-50 border-b border-yellow-200">
        <div class="max-w-7xl mx-auto px-6 py-3">
            <p class="text-sm text-yellow-800">
                <strong>Demo Mode:</strong> Data verified using AI search (Perplexity) with government sources. Users should verify important claims via provided links.
            </p>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <h1 class="text-3xl font-bold mb-6">Political Promise Tracker</h1>
        
        <div id="stats" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <!-- Stats cards inserted here by JavaScript -->
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-wrap gap-4">
                <select id="statusFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="kept">Kept</option>
                    <option value="broken">Broken</option>
                    <option value="partial">Partial</option>
                </select>
                
                <select id="presidentFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">All Presidents</option>
                </select>

                <select id="categoryFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>

        <!-- Promises Grid -->
        <div id="promises" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Promise cards inserted here -->
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="handleModalBackdropClick(event)">
        <div class="bg-white rounded-xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div id="modalContent"></div>
            <button onclick="closeModal()" class="mt-6 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Close</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-700 font-medium">Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: window.location.hostname === 'localhost' 
                ? 'http://localhost:3000/api' 
                : '/api'
        };

        // State management
        let allPromises = [];
        let currentFilters = { 
            status: '', 
            president: '', 
            category: '' 
        };

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function sanitizeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJSON(obj) {
            return JSON.stringify(obj)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '&quot;');
        }

        // Load promises
        async function loadPromises() {
            showLoading();
            try {
                const response = await fetch(`${CONFIG.API_BASE}/promises`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                allPromises = await response.json();
                
                if (!Array.isArray(allPromises)) {
                    throw new Error('Invalid data format received from API');
                }
                
                populateFilters();
                loadStats();
                renderPromises();
                
            } catch (error) {
                console.error('Failed to load promises:', error);
                document.getElementById('promises').innerHTML = `
                    <div class="col-span-full bg-red-50 border border-red-200 rounded-lg p-8 text-center">
                        <p class="text-red-600 font-semibold text-lg mb-2">Failed to Load Data</p>
                        <p class="text-sm text-red-500 mb-4">${sanitizeHTML(error.message)}</p>
                        <p class="text-xs text-gray-600">Make sure the backend is running at <code class="bg-gray-100 px-2 py-1 rounded">${CONFIG.API_BASE}</code></p>
                        <button onclick="loadPromises()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            Retry
                        </button>
                    </div>
                `;
                document.getElementById('stats').innerHTML = '';
            } finally {
                hideLoading();
            }
        }

        // Load stats
        function loadStats() {
            const stats = {
                total: allPromises.length,
                kept: allPromises.filter(p => p.status === 'kept').length,
                broken: allPromises.filter(p => p.status === 'broken').length,
                partial: allPromises.filter(p => p.status === 'partial').length
            };
            
            const accountabilityScore = stats.total > 0 
                ? Math.round((stats.kept / stats.total) * 100) 
                : 0;
            
            document.getElementById('stats').innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-blue-600">${stats.total}</div>
                    <div class="text-sm text-gray-600 mt-1">Total Promises</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-green-600">${stats.kept}</div>
                    <div class="text-sm text-gray-600 mt-1">Kept</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-yellow-600">${stats.partial}</div>
                    <div class="text-sm text-gray-600 mt-1">Partial</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-red-600">${stats.broken}</div>
                    <div class="text-sm text-gray-600 mt-1">Broken</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                    <div class="text-3xl font-bold text-purple-600">${accountabilityScore}%</div>
                    <div class="text-sm text-gray-600 mt-1">Accountability Score</div>
                </div>
            `;
        }

        // Populate filters
        function populateFilters() {
            const presidents = [...new Set(allPromises.map(p => p.president))].filter(Boolean);
            const categories = [...new Set(allPromises.map(p => p.category))].filter(Boolean);
            
            document.getElementById('presidentFilter').innerHTML = `
                <option value="">All Presidents</option>
                ${presidents.map(p => `<option value="${sanitizeHTML(p)}">${sanitizeHTML(p)}</option>`).join('')}
            `;
            
            document.getElementById('categoryFilter').innerHTML = `
                <option value="">All Categories</option>
                ${categories.map(c => `<option value="${sanitizeHTML(c)}">${sanitizeHTML(c)}</option>`).join('')}
            `;
        }

        // Render promises
        function renderPromises() {
            const filtered = allPromises.filter(p => {
                if (currentFilters.status && p.status !== currentFilters.status) return false;
                if (currentFilters.president && p.president !== currentFilters.president) return false;
                if (currentFilters.category && p.category !== currentFilters.category) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                document.getElementById('promises').innerHTML = `
                    <div class="col-span-full text-center p-12">
                        <div class="text-gray-400 text-6xl mb-4">🔍</div>
                        <p class="text-gray-500 text-lg font-medium">No promises match your filters</p>
                        <button onclick="resetFilters()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('promises').innerHTML = filtered.map((promise, index) => {
                const safePromise = {
                    id: promise.id || index,
                    promise: sanitizeHTML(promise.promise || 'No description'),
                    president: sanitizeHTML(promise.president || 'Unknown'),
                    date: sanitizeHTML(promise.date || 'Unknown date'),
                    category: sanitizeHTML(promise.category || 'Uncategorized'),
                    status: promise.status || 'unknown',
                    verified: Boolean(promise.verified),
                    credibilityLevel: promise.credibilityLevel || 'unverified',
                    affectedIndustries: Array.isArray(promise.affectedIndustries) ? promise.affectedIndustries : []
                };

                return `
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition p-6 cursor-pointer"
                         data-promise-id="${safePromise.id}">
                        
                        <div class="flex justify-between items-start mb-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(safePromise.status)}">
                                ${sanitizeHTML(safePromise.status.toUpperCase())}
                            </span>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getCredibilityColor(safePromise.credibilityLevel)}">
                                ${safePromise.verified ? '✓ Verified' : '⚠ Unverified'}
                            </span>
                        </div>
                        
                        <h3 class="font-bold text-gray-900 mb-3 line-clamp-2">${safePromise.promise}</h3>
                        
                        <div class="text-sm text-gray-600 space-y-1 mb-4">
                            <p class="font-semibold">${safePromise.president}</p>
                            <p>${safePromise.date} • ${safePromise.category}</p>
                        </div>
                        
                        ${safePromise.affectedIndustries.length > 0 ? `
                            <div class="flex flex-wrap gap-2">
                                ${safePromise.affectedIndustries.slice(0, 3).map(ind => `
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                                        ${sanitizeHTML(ind.name || ind)}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('[data-promise-id]').forEach((card, index) => {
                card.addEventListener('click', () => {
                    const filtered = allPromises.filter(p => {
                        if (currentFilters.status && p.status !== currentFilters.status) return false;
                        if (currentFilters.president && p.president !== currentFilters.president) return false;
                        if (currentFilters.category && p.category !== currentFilters.category) return false;
                        return true;
                    });
                    openAnalysis(filtered[index]);
                });
            });
        }

        function getStatusColor(status) {
            const colors = {
                kept: 'bg-green-100 text-green-800',
                broken: 'bg-red-100 text-red-800',
                partial: 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getCredibilityColor(level) {
            const colors = {
                high: 'bg-green-100 text-green-700',
                medium: 'bg-yellow-100 text-yellow-700',
                low: 'bg-orange-100 text-orange-700',
                unverified: 'bg-red-100 text-red-700'
            };
            return colors[level] || 'bg-gray-100 text-gray-700';
        }

        async function openAnalysis(promise) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            // Show modal with loading state
            modal.classList.remove('hidden');
            modalContent.innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Analyzing promise...</p>
                </div>
            `;

            try {
                const response = await fetch(`${CONFIG.API_BASE}/cross-verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        promise: promise.promise || 'No description available'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Display comparison
                modalContent.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">${sanitizeHTML(promise.promise)}</h2>
                    
                    ${result.biasWarning ? `
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-yellow-800"><strong>⚠️ ${sanitizeHTML(result.biasWarning)}</strong></p>
                            <p class="text-sm text-yellow-700">AIs disagree - review sources carefully</p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="border-l-4 border-purple-500 pl-4 bg-purple-50 p-4 rounded">
                            <h3 class="font-bold text-purple-700 mb-2">Gemini Analysis</h3>
                            <p class="text-sm text-gray-700 mb-2">${sanitizeHTML(result.gemini?.analysis || 'No analysis available')}</p>
                            <p class="text-xs text-purple-600 font-semibold">Confidence: ${result.gemini?.confidence || 0}%</p>
                        </div>
                        <div class="border-l-4 border-blue-500 pl-4 bg-blue-50 p-4 rounded">
                            <h3 class="font-bold text-blue-700 mb-2">Perplexity Verification</h3>
                            <p class="text-sm text-gray-700 mb-2">${sanitizeHTML(result.perplexity?.analysis || 'No verification available')}</p>
                            <p class="text-xs text-blue-600 font-semibold">Sources: ${result.perplexity?.sources?.length || 0}</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <strong class="text-gray-800">AI Agreement Score</strong>
                            <span class="text-2xl font-bold text-gray-900">${result.agreementScore || 0}%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3">
                            <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500" 
                                 style="width: ${result.agreementScore || 0}%"></div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Analysis failed:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-500 text-5xl mb-4">⚠️</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Analysis Failed</h3>
                        <p class="text-red-600 mb-4">${sanitizeHTML(error.message)}</p>
                        <p class="text-sm text-gray-600 mb-4">The cross-verification service may be unavailable.</p>
                        <button onclick="openAnalysis(${escapeJSON(promise)})" 
                                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function handleModalBackdropClick(event) {
            if (event.target.id === 'modal') {
                closeModal();
            }
        }

        function resetFilters() {
            currentFilters = { status: '', president: '', category: '' };
            document.getElementById('statusFilter').value = '';
            document.getElementById('presidentFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            renderPromises();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Filter handlers
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentFilters.status = e.target.value;
            renderPromises();
        });

        document.getElementById('presidentFilter').addEventListener('change', (e) => {
            currentFilters.president = e.target.value;
            renderPromises();
        });

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            renderPromises();
        });

        // Initialize
        loadPromises();
    </script>
</body>
</html>
